#!/usr/bin/env ruby

require 'mysql2'
require './http_server.rb'
require './blog_controller.rb'

PAGE_NAME = "PJ's Site" # The name of the site

server = HTTPServer.new
controller = BlogController.new
loop do
  server.serve do |socket|
    request = socket.gets   # Gets data sent to socket
    STDERR.puts request     # Prints recieved requests to console

    requested_path = request.split(' ')[1]
    if(requested_path.end_with?(*HTTPServer::MIME_TYPES.keys))
      HTTPServer.file_response(".#{requested_path}", socket)
    elsif(requested_path == '/')
      @recent_posts = controller.recent_posts(5)
      socket.print HTTPServer.generic_html(BlogController::TEMPLATES[:homepage].result)
    elsif(requested_path == '/archive')
      @post_archive = controller.fetch_archive
      socket.print HTTPServer.generic_html(BlogController::TEMPLATES[:archive].result)
    else
      slug = requested_path[1..-1] # Gets the slug of the post requested
      socket.print controller.parse_slug_request(slug) # Sends the requested content back to the client
    end
  end
end
