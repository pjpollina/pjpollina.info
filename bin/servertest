#!/usr/bin/env ruby

require 'erb'
require 'mysql2'
require './http_server.rb'
require './blog_controller.rb'

PAGE_NAME = "PJ's Site" # The name of the site

server = HTTPServer.new
controller = BlogController.new
homepage = ERB.new(File.read './templates/blog_home.erb')
archive = ERB.new(File.read './templates/blog_archive.erb')
loop do
  server.serve do |socket|
    request = socket.gets   # Gets data sent to socket
    STDERR.puts request     # Prints recieved requests to console

    requested_path = request.split(' ')[1]
    if(requested_path.end_with?('png', 'jpg', 'ico'))
      HTTPServer.file_response(".#{requested_path}", socket)
    elsif(requested_path.end_with?('css', 'js', 'json'))
      HTTPServer.file_response(".#{requested_path}", socket)
    elsif(requested_path == '/')
      @recent_posts = controller.recent_posts(5)
      socket.print HTTPServer.generic_html(homepage.result)
    elsif(requested_path == '/archive')
      postdata = controller.all_posts
      @post_archive = {}
      active_year = nil
      active_month = nil
      postdata.each do |post|
        ts = post['post_timestamp']
        if active_year != ts.year
          @post_archive[ts.year] = {}
          active_year = ts.year
        end
        if active_month != ts.strftime('%B')
          @post_archive[active_year][ts.strftime('%B')] = []
          active_month = ts.strftime('%B')
        end
        @post_archive[active_year][active_month] << post
      end
      socket.print HTTPServer.generic_html(archive.result)
    else
      slug = requested_path[1..-1] # Gets the slug of the post requested
      socket.print controller.parse_slug_request(slug) # Sends the requested content back to the client
    end
  end
end
