#!/usr/bin/env ruby

require './lib/http_server.rb'
require './lib/blog_controller.rb'

server = HTTPServer.new
controller = BlogController.new
loop do
  server.serve do |socket, request|
    STDERR.puts "#{request[:method]} #{request[:path]} #{request[:client_type]}"

    case(request[:method])
    when 'GET'
      if(request[:path].end_with?(*HTTPServer::MIME_TYPES.keys))
        HTTPServer.file_response(request[:path], socket)
      elsif(request[:path].end_with?('html'))
        socket.print HTTPServer.static_html(request[:path])
      elsif(request[:path].start_with? '/validate')
        data = HTTPServer.parse_form_data(request[:path].split("?")[1])
        value = false
        case data.keys[0]
        when 'title'
          value = controller.title_valid?(data['title'])
        when 'slug'
          value = controller.slug_valid?(data['slug'])
        end
        socket.print "HTTP/1.1 200 OK\r\n\r\n#{value}\r\n\r\n"
      else
        socket.print controller.respond(request[:path], request[:admin])
      end
    when 'POST'
      case request[:path]
      when '/new_blog_post'
        if(request[:admin])
          socket.print controller.post_new_blogpost(socket.read(request[:headers]['Content-Length'].to_i))
        end
      when '/admin-login'
        socket.print controller.post_admin_login(socket.read(request[:headers]['Content-Length'].to_i), request[:ip])
      end
    when 'PUT'
      elements = HTTPServer.parse_form_data(socket.read(request[:headers]['Content-Length'].to_i))
      controller.update_post(elements)
      socket.print "HTTP/1.1 200 OK\r\nLocation: /#{elements['slug']}\r\n\r\n/#{elements['slug']}\r\n\r\n"
    when 'DELETE'
      elements = HTTPServer.parse_form_data(socket.read(request[:headers]['Content-Length'].to_i))
      controller.delete_post(elements)
      socket.print "HTTP/1.1 200 OK\r\nLocation: /#{elements['slug']}\r\n\r\n"
    end
  end
end
