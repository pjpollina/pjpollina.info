#!/usr/bin/env ruby

# Converts a post in the database to a plain-text file

require 'erb'
require 'mysql2'

$dbclient = Mysql2::Client.new(
  username: 'blogapp',
  password: ENV['mysql_blogapp_password'],
  database: 'blog'
)

$template = ERB.new <<~TEMPLATE
  ---
  id: <%= post['post_id'] %>
  title: '<%= post['post_title'] %>'
  slug: '<%= post['post_slug'] %>'
  timestamp: '<%= post['post_timestamp'] %>'
  ---

  <%= post['post_body'] %>
TEMPLATE
if(ARGV[0].nil?)
  abort "No post slug provided"
end

post = $dbclient.query("SELECT * FROM posts WHERE post_slug='#{ARGV[0]}'").first
if(post.nil?)
  abort "No post with the slug #{ARGV[0]}"
end

puts $template.result